---
title: "W241 Final Project - Main Script"
author: "Fisher Kim, Kai Ying, Lucas Schroyer, Peter YH Kim"
date: '2022-04-03'
output:
  pdf_document: default
  word_document: default
---

## Introduction

This is the markdown script for a final project for the UC Berkeley School of Information - W241.


## Configurations and Load Packages
```{r global options, include = FALSE}
knitr::opts_chunk$set(include = FALSE, message = FALSE, warning = FALSE )

knitr::knit_engines$set(problem_description = function(options) {
  code <- paste(options$code, collapse = "\n")
})

```

```{r load packages, message = FALSE}
library(data.table)

if (!require("lmtest")) install.packages("lmtest")
if (!require("sandwich")) install.packages("sandwich")
if (!require("patchwork")) install.packages("patchwork")
if (!require("stargazer")) install.packages("stargazer")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("janitor")) install.packages("janitor")
if (!require("AER")) install.packages("AER")


library(sandwich)
library(lmtest)

library(AER) 

library(ggplot2) 
library(patchwork)

library(tidyverse)

library(janitor)


```
## Theory and Background 


## Load and Clean Data

You can also embed plots, for example:

```{r load_data, echo=FALSE}
d <- fread('../src/data/W241 Survey StoryTelling Experiment_April 4, 2022_12.40.csv')

# Transform Column Names
d <- janitor::clean_names(d)

# Create Column Dictionary
d_dict <- d[1:1,]
d <- d[3:nrow(d),] #if exporting a csv from Qualtrics, use third row. Excel is 2

# Drop people that opted out before randomization
d <- d %>% filter(nda %like% "Yes")

# referral counts
d %>% count(referral_person) 

# Drop unnecessary columns
d <- d %>% 
  select(-ip_address, -progress, -recipient_first_name, -recipient_last_name, 
         -location_latitude, -location_longitude, -distribution_channel, -notice,
         -time_control_alien_click_count, -facts_aliens, -info_recycling, -facts_social) 
  
# Transform columns:
d <- d[, alien_treatment_bool := ifelse(alien_control == "", 0, 1)]
d <- d[, recyc_treatment_bool := ifelse(recycle_control == "", 0, 1)]
d <- d[, social_treatment_bool := ifelse(control_social == "", 0, 1)]

d <- d %>% rename(alien_quiz_for_1 = alien_quiz_q1, 
                  alien_quiz_for_2 = alien_quiz_q2,
                  alien_quiz_against_1 = alien_quiz_q4,
                  alien_quiz_against_2 = alien_quiz_q3,
                  recycle_quiz_for_1 = recycle_quiz_q2,
                  recycle_quiz_for_2 = recycle_quiz_q4,
                  recycle_quiz_against_1 = recycle_quiz_q1,
                  recycle_quiz_against_2 = recycle_quiz_q3,
                  social_quiz_for_1 = social_quiz_q1, 
                  social_quiz_for_2 = social_quiz_q2, 
                  social_quiz_against_1 = social_quiz_q3, 
                  social_quiz_against_2 = social_quiz_q4)


# Calculate what questions (for or against) each participant got right
quiz_results_raw <- d %>% select(contains("quiz")) 

quiz_answer_key_alien <- tibble(question = 
                            c("alien_quiz_for_1", "alien_quiz_for_2", 
                              "alien_quiz_against_1" ,"alien_quiz_against_2"), 
                          answer = 
                            c("10,000", "Only 19 out of the 144 reports",
                              "Project Aquatone", "National Geographic"))

quiz_answer_key_recycle <- tibble(question = 
                            c("recycle_quiz_for_1", "recycle_quiz_for_2", 
                              "recycle_quiz_against_1" ,"recycle_quiz_against_2"), 
                          answer = 
                            c("20 million cars off of U.S. roads and highways", 
                              "Recycling and composting, but not waste management",
                              "2-3","90%"))

quiz_answer_key_social <- tibble(question = 
                            c("social_quiz_for_1", "social_quiz_for_2", 
                              "social_quiz_against_1" ,"social_quiz_against_2"), 
                          answer = 
                            c("FamilyOK", 
                              "feel more connected to their friends",
                              "six", "Because of teensâ€™ impulsive natures"))

quiz_answer_key <- quiz_answer_key_alien %>% 
  bind_rows(quiz_answer_key_recycle) %>% 
  bind_rows(quiz_answer_key_social)


quiz_score <- function(col_name){

  question_answer <- quiz_answer_key %>% 
    filter(question == col_name) %>% 
    select(answer) %>% 
    as.character()
  
  col_correct <- as.integer(d[[col_name]] == question_answer)
  
  return(col_correct)
  }

d_graded <- quiz_results_raw %>% 
  names() %>% 
  map_dfc(quiz_score) 

names(d_graded) <- paste0(quiz_results_raw %>% 
  names(), "_correct")

d_2 <- d %>% bind_cols(d_graded)

d_2 <- d_2 %>% 
  mutate(alien_quiz_for_correct = (alien_quiz_for_1_correct + alien_quiz_for_2_correct)/2,
         recycle_quiz_for_correct = (recycle_quiz_for_1_correct + recycle_quiz_for_2_correct)/2,
         social_quiz_for_correct = (social_quiz_for_1_correct + social_quiz_for_2_correct)/2,
         alien_quiz_against_correct = (alien_quiz_against_1_correct + alien_quiz_against_2_correct)/2,
         recycle_quiz_against_correct = (recycle_quiz_against_1_correct + recycle_quiz_against_2_correct)/2,
         social_quiz_against_correct = (social_quiz_against_1_correct + social_quiz_against_2_correct)/2)

d_3 <- d_2 %>% 
  # select(alien_treatment_bool, recyc_treatment_bool, social_treatment_bool, sc1, sc2, sc3) %>%
  gather(key = "treatment_question", value = "treatment_bool", 
         alien_treatment_bool, recyc_treatment_bool, social_treatment_bool) %>% 
  gather(key = "treatment_for_question", value = "treatment_for_bool", 
         alien_quiz_for_correct, recycle_quiz_for_correct, social_quiz_for_correct) %>% 
  gather(key = "treatment_against_question", value = "treatment_against_bool", 
         alien_quiz_against_correct, recycle_quiz_against_correct, social_quiz_against_correct) %>% 
  gather(key = "quiz_question", value = "quiz_correct_num", sc1, sc2, sc3) %>% 
  mutate(quiz_perc_correct = as.double(quiz_correct_num)/4) %>% 
  as.data.table()




d_3 %>% glimpse()


```



```{r regression basic}


model_basic <- d_3 %>% 
  select(response_id, quiz_perc_correct, treatment_question, treatment_bool) %>% 
  unique() %>% 
  arrange(response_id) %>% 
  lm(quiz_perc_correct ~ treatment_bool, data = .)

# TODO - QC why the gathers result in two copies of each with different scores
#          response_id quiz_perc_correct    treatment_question treatment_bool
# 1: R_0JoNfdq3IWhf0LT               1.0  alien_treatment_bool              1
# 2: R_0JoNfdq3IWhf0LT               1.0  recyc_treatment_bool              0
# 3: R_0JoNfdq3IWhf0LT               1.0 social_treatment_bool              1
# 4: R_0JoNfdq3IWhf0LT               0.5  alien_treatment_bool              1
# 5: R_0JoNfdq3IWhf0LT               0.5  recyc_treatment_bool              0
# 6: R_0JoNfdq3IWhf0LT               0.5 social_treatment_bool              1


summary(model_basic)

# TODO - Update treatment_bool as this isn't correct.
model_for_basic <- d_3 %>% 
  select(response_id, quiz_for_correct, treatment_bool) %>% 
  unique() %>% 
  lm(quiz_for_correct ~ treatment_bool, data = .)

summary(model_for_basic)

```

``` {r regression with covariates}


```
